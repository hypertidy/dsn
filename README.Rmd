---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# dsn

<!-- badges: start -->
[![R-CMD-check](https://github.com/hypertidy/dsn/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/hypertidy/dsn/actions/workflows/R-CMD-check.yaml)
<!-- badges: end -->

The goal of dsn is to provide simple helpers for [GDAL](https://gdal.org/) data source name prefixes and related string handling. 

Please note that dsn is not doing anything *with GDAL*, this is pure string handling for things commonly used for GDAL: 

- prefixing `/viscurl/` to an online data source url for [GDAL's Virtual File System](https://gdal.org/user/virtual_file_systems.html)
- prefixing a driver declaration to a data source, e.g. `HDF5:/my/files/data.h5` or `NETCDF:C:/temp/nc/afile.nc`
- wrapping a [subdataset](https://gdal.org/user/raster_data_model.html#subdatasets-domain)  declaration, e.g. `NETCDF:/myfiles/data.nc:variable` that can occur in [NETCDF](https://gdal.org/drivers/raster/netcdf.html#multiple-image-handling-subdatasets) and similar formats
- wrapping a [VRT connection](https://gdal.org/drivers/raster/vrt.html#vrt-connection-string), e.g. `vrt://myfile.tif?bands=3,2,1`

Please see [vapour::vapour_vrt()](https://hypertidy.github.io/vapour/reference/vapour_vrt.html) for actual use of GDAL to extend a data source name by opening the source and augmenting available information. dsn is intended to support that usage, and in general intends to be purely string handling, and not make use of the format libraries at all. 

## Installation

You can install the development version of dsn from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("hypertidy/dsn")
```

## Example

This is a basic example, add in the prefix for a vsicurl. 

```{r example}
library(dsn)
vsicurl("https://netcdf-r-us.org/f.nc")

driver("somefile.h5", "HDF5")

unvsicurl("/vsicurl/https://netcdf-r-us.org/f.nc")

unprefix("NETCDF:/u/user/somefile.nc")
```


NetCDF is a very common source and occasionally requires explicit driver declaration, so we have a simple `driver()` wrapper for that. 

```{r netcdf}
(nc <- netcdf("/u/user/somfile.nc"))

unprefix(nc)
```



## Real world example

Here is a less basic and real world example. 

```
https://www.ncei.noaa.gov/data/sea-surface-temperature-optimum-interpolation/v2.1/access/avhrr/202109/oisst-avhrr-v02r01.20210930.nc

```
These files have four variables and so need to be referenced using subdataset syntax.  They are online so we need GDAL's virtual file system [vsicurl](https://gdal.org/user/virtual_file_systems.html) to access it.  Also, they are non-compliant NetCDF in that they don't declare in a robust way what their coordinate reference system is (it's longlat). 

(Even if you have the files locally you still need the subdataset and crs handling). 

So, we can find this stuff out with investigation.  See there are subdatasets `sst`, `anom`, `err`, `ice`. 

```{r investigate}
u <- "https://www.ncei.noaa.gov/data/sea-surface-temperature-optimum-interpolation/v2.1/access/avhrr/202109/oisst-avhrr-v02r01.20210930.nc"
str(vapour::vapour_raster_info(file.path("/vsicurl", u)))
```

And, with GDAL tools we can augment the missing metadata and get the subdatasets etc. 

Please note that the subdatasets might not always be in order, you really need to ask for them by name. 
```{r vapour_sds}
sds <- vapour::vapour_sds_names(file.path("/vsicurl", u))
(sst0 <- grep(":sst$", sds, value = TRUE))
```

Finally, now we take that subdataset and augment it (this creates a GDAL open dataset in memory, and serializes it to in-memory VRT text). 

```{r vapour_vrt}
vrt <- vapour::vapour_vrt(sst0, projection = "OGC:CRS84")

vrt

str(vapour::vapour_raster_info(vrt))
```

Ok so finally we have a solid GDAL DSN that we can use. But, that whole process was expensive, I don't want to do that for all 15000 of those NetCDF files, and I don't want to store unwieldy VRT text either. 

So the dsn package has the following functions `vsicurl()`, `sds()`, and `vrtcon()`. 

(`vrtcon()` is for [VRT connection](https://gdal.org/drivers/raster/vrt.html#vrt-connection-string), there are new features coming for that in GDAL 3.7). 

None of this requires GDAL or for any file or URL querying to be done at all. This is useful because *we already did it* many times over many years, and now we want to summarize our hard won knowledge in a simple augmented file or URL DSN. 

```{r vrtcon}
library(dsn)
(vsi <- vsicurl(u))

(sds <- sds(vsi, "sst", "NETCDF"))

(DSN <- vrtcon(sds, a_srs = "OGC:CRS84"))

## and with that tiny bit of text we are also language independent
## (but my python installation is not up to scratch yet ...)

```

Here is a gdalinfo output just to prove it works (requires GDAL 3.7 for the `vrt://...?a_srs` syntax). 


```
gdalinfo "vrt://NETCDF:\"/vsicurl/https://www.ncei.noaa.gov/data/sea-surface-temperature-optimum-interpolation/v2.1/access/avhrr/202109/oisst-avhrr-v02r01.20210930.nc\":sst?a_srs=OGC:CRS84" -nomd
Driver: VRT/Virtual Raster
Files: NETCDF:"/vsicurl/https://www.ncei.noaa.gov/data/sea-surface-temperature-optimum-interpolation/v2.1/access/avhrr/202109/oisst-avhrr-v02r01.20210930.nc":sst
Size is 1440, 720
Coordinate System is:
GEOGCRS["WGS 84",
    DATUM["World Geodetic System 1984",
        ELLIPSOID["WGS 84",6378137,298.257223563,
            LENGTHUNIT["metre",1]],
        ID["EPSG",6326]],
    PRIMEM["Greenwich",0,
        ANGLEUNIT["degree",0.0174532925199433],
        ID["EPSG",8901]],
    CS[ellipsoidal,2],
        AXIS["longitude",east,
            ORDER[1],
            ANGLEUNIT["degree",0.0174532925199433,
                ID["EPSG",9122]]],
        AXIS["latitude",north,
            ORDER[2],
            ANGLEUNIT["degree",0.0174532925199433,
                ID["EPSG",9122]]]]
Data axis to CRS axis mapping: 1,2
Origin = (0.000000000000000,90.000000000000000)
Pixel Size = (0.250000000000000,-0.250000000000000)
Corner Coordinates:
Upper Left  (   0.0000000,  90.0000000) (  0d 0' 0.01"E, 90d 0' 0.00"N)
Lower Left  (   0.0000000, -90.0000000) (  0d 0' 0.01"E, 90d 0' 0.00"S)
Upper Right (     360.000,      90.000) (360d 0' 0.00"E, 90d 0' 0.00"N)
Lower Right (     360.000,     -90.000) (360d 0' 0.00"E, 90d 0' 0.00"S)
Center      ( 180.0000000,   0.0000000) (180d 0' 0.00"E,  0d 0' 0.01"N)
Band 1 Block=1440x720 Type=Int16, ColorInterp=Undefined
  NoData Value=-999
  Unit Type: Celsius
  Offset: 0,   Scale:0.00999999977648258

```

## Code of Conduct
  
Please note that the dsn project is released with a [Contributor Code of Conduct](https://contributor-covenant.org/version/2/1/CODE_OF_CONDUCT.html). By contributing to this project, you agree to abide by its terms.
